<UserControl x:Class="GCS.Views.MissionTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="480">

    <UserControl.Resources>
        <SolidColorBrush x:Key="CardBackground" Color="#1C2128"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#2D333D"/>
        <SolidColorBrush x:Key="PrimaryText" Color="#E6EDF3"/>
        <SolidColorBrush x:Key="SecondaryText" Color="#8B949E"/>
        <SolidColorBrush x:Key="AccentGreen" Color="#3FB950"/>
        <SolidColorBrush x:Key="AccentBlue" Color="#58A6FF"/>
        <SolidColorBrush x:Key="AccentCyan" Color="#39D0D8"/>
        <SolidColorBrush x:Key="AccentOrange" Color="#FF9500"/>
        <SolidColorBrush x:Key="AccentRed" Color="#F85149"/>
        <SolidColorBrush x:Key="AccentPurple" Color="#A371F7"/>

        <Style x:Key="SmallButton" TargetType="Button">
            <Setter Property="Height" Value="28"/>
            <Setter Property="MinWidth" Value="28"/>
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Margin" Value="2"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Background" Value="{StaticResource CardBackground}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="0.85"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.4"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ActionButton" TargetType="Button" BasedOn="{StaticResource SmallButton}">
            <Setter Property="Height" Value="32"/>
            <Setter Property="FontSize" Value="11"/>
        </Style>

        <Style x:Key="LabelText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource SecondaryText}"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Margin" Value="0,0,0,3"/>
        </Style>

        <Style x:Key="ValueInput" TargetType="TextBox">
            <Setter Property="Background" Value="#0D1117"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryText}"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6,4"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
    </UserControl.Resources>

    <Grid Margin="8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header & Status -->
        <StackPanel Grid.Row="0" Margin="0,0,0,8">
            <TextBlock Text="MISSION PLANNER" Foreground="{StaticResource SecondaryText}" FontSize="11" FontWeight="Bold"/>
            <TextBlock Text="{Binding Status}" Foreground="{StaticResource AccentBlue}" FontSize="12" Margin="0,4,0,0"/>
        </StackPanel>

        <!-- Default Settings Row -->
        <Border Grid.Row="1" Background="{StaticResource CardBackground}" BorderBrush="{StaticResource BorderBrush}" 
                BorderThickness="1" CornerRadius="4" Padding="10,8" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="10"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Type -->
                <StackPanel Grid.Column="0">
                    <TextBlock Text="TYPE" Style="{StaticResource LabelText}"/>
                    <ComboBox SelectedIndex="{Binding SelectedCommandIndex}" Height="28" FontSize="11">
                        <ComboBoxItem Content="WAYPOINT"/>
                        <ComboBoxItem Content="TAKEOFF"/>
                        <ComboBoxItem Content="LAND"/>
                        <ComboBoxItem Content="LOITER"/>
                        <ComboBoxItem Content="RTL"/>
                    </ComboBox>
                </StackPanel>

                <!-- Altitude -->
                <StackPanel Grid.Column="2">
                    <TextBlock Text="ALT (m)" Style="{StaticResource LabelText}"/>
                    <TextBox Text="{Binding DefaultAltitude, UpdateSourceTrigger=PropertyChanged}" 
                            Style="{StaticResource ValueInput}" Height="28"/>
                </StackPanel>

                <!-- Radius -->
                <StackPanel Grid.Column="4" Width="60">
                    <TextBlock Text="RADIUS" Style="{StaticResource LabelText}"/>
                    <TextBox Text="{Binding DefaultRadius, UpdateSourceTrigger=PropertyChanged}" 
                            Style="{StaticResource ValueInput}" Height="28"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Statistics Row -->
        <Border Grid.Row="2" Background="#0D1117" BorderBrush="{StaticResource BorderBrush}" 
                BorderThickness="1" CornerRadius="4" Padding="10,6" Margin="0,0,0,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="DISTANCE:" Foreground="{StaticResource SecondaryText}" FontSize="10" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding TotalDistanceText}" Foreground="{StaticResource AccentCyan}" 
                              FontSize="12" FontWeight="Bold" Margin="6,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                    <TextBlock Text="EST. TIME:" Foreground="{StaticResource SecondaryText}" FontSize="10" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding EstimatedTime}" Foreground="{StaticResource AccentOrange}" 
                              FontSize="12" FontWeight="Bold" Margin="6,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Waypoint List -->
        <Border Grid.Row="3" Background="{StaticResource CardBackground}" BorderBrush="{StaticResource BorderBrush}" 
                BorderThickness="1" CornerRadius="4" Margin="0,0,0,8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- List Header -->
                <Border Grid.Row="0" Background="#151922" Padding="8,6" CornerRadius="4,4,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="30"/>
                            <ColumnDefinition Width="45"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="40"/>
                            <ColumnDefinition Width="40"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Grid.Column="0" Text="#" Foreground="{StaticResource SecondaryText}" FontSize="9" FontWeight="Bold"/>
                        <TextBlock Grid.Column="1" Text="TYPE" Foreground="{StaticResource SecondaryText}" FontSize="9" FontWeight="Bold"/>
                        <TextBlock Grid.Column="2" Text="LAT" Foreground="{StaticResource SecondaryText}" FontSize="9" FontWeight="Bold"/>
                        <TextBlock Grid.Column="3" Text="LON" Foreground="{StaticResource SecondaryText}" FontSize="9" FontWeight="Bold"/>
                        <TextBlock Grid.Column="4" Text="ALT" Foreground="{StaticResource SecondaryText}" FontSize="9" FontWeight="Bold"/>
                        <TextBlock Grid.Column="5" Text="RAD" Foreground="{StaticResource SecondaryText}" FontSize="9" FontWeight="Bold"/>
                    </Grid>
                </Border>

                <!-- Waypoint Items -->
                <ListBox Grid.Row="1" ItemsSource="{Binding Waypoints}" SelectedIndex="{Binding SelectedIndex}"
                        Background="Transparent" BorderThickness="0" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="8,5"/>
                            <Setter Property="Background" Value="Transparent"/>
                            <Setter Property="Foreground" Value="{StaticResource PrimaryText}"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter Property="Background" Value="#2D333D"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Background" Value="#252B33"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="30"/>
                                    <ColumnDefinition Width="45"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="40"/>
                                    <ColumnDefinition Width="40"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{Binding Sequence}" Foreground="{StaticResource AccentBlue}" FontWeight="Bold" FontSize="11"/>
                                <TextBlock Grid.Column="1" Text="{Binding CommandName}" Foreground="{StaticResource AccentOrange}" FontSize="10" FontWeight="Bold"/>
                                <TextBlock Grid.Column="2" Text="{Binding Latitude, StringFormat=F5}" FontSize="9"/>
                                <TextBlock Grid.Column="3" Text="{Binding Longitude, StringFormat=F5}" FontSize="9"/>
                                <TextBlock Grid.Column="4" Text="{Binding Altitude, StringFormat=F0}" Foreground="{StaticResource AccentGreen}" FontSize="10"/>
                                <TextBlock Grid.Column="5" Text="{Binding Radius, StringFormat=F0}" Foreground="{StaticResource AccentPurple}" FontSize="10"/>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <!-- Empty State -->
                <TextBlock Grid.Row="1" Text="Click on map to add waypoints" Foreground="{StaticResource SecondaryText}" 
                          FontSize="11" HorizontalAlignment="Center" VerticalAlignment="Center"
                          Visibility="{Binding Waypoints.Count, Converter={StaticResource ZeroToVisibleConverter}, FallbackValue=Visible}"/>
            </Grid>
        </Border>

        <!-- Edit Panel (when waypoint selected) -->
        <Border Grid.Row="4" Background="{StaticResource CardBackground}" BorderBrush="{StaticResource AccentBlue}" 
                BorderThickness="1" CornerRadius="4" Padding="10" Margin="0,0,0,8"
                Visibility="{Binding HasSelection, Converter={StaticResource BoolToVisibilityConverter}, FallbackValue=Collapsed}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Edit Header -->
                <TextBlock Grid.Row="0" FontSize="10" FontWeight="Bold" Foreground="{StaticResource AccentBlue}" Margin="0,0,0,8">
                    <Run Text="EDIT WP #"/><Run Text="{Binding SelectedWaypoint.Sequence, FallbackValue=0}"/>
                </TextBlock>

                <!-- Edit Fields Row 1 -->
                <Grid Grid.Row="1" Margin="0,0,0,6">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="8"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="8"/>
                        <ColumnDefinition Width="70"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="LATITUDE" Style="{StaticResource LabelText}"/>
                        <TextBox Text="{Binding SelectedWaypoint.Latitude, StringFormat=F7, UpdateSourceTrigger=PropertyChanged}" 
                                Style="{StaticResource ValueInput}" Height="26" FontSize="10"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="LONGITUDE" Style="{StaticResource LabelText}"/>
                        <TextBox Text="{Binding SelectedWaypoint.Longitude, StringFormat=F7, UpdateSourceTrigger=PropertyChanged}" 
                                Style="{StaticResource ValueInput}" Height="26" FontSize="10"/>
                    </StackPanel>

                    <StackPanel Grid.Column="4">
                        <TextBlock Text="TYPE" Style="{StaticResource LabelText}"/>
                        <TextBox Text="{Binding SelectedWaypoint.CommandName, Mode=OneWay}" 
                                Style="{StaticResource ValueInput}" Height="26" FontSize="10" IsReadOnly="True"
                                Background="#151922"/>
                    </StackPanel>
                </Grid>

                <!-- Edit Fields Row 2 -->
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="8"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="8"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0">
                        <TextBlock Text="ALTITUDE (m)" Style="{StaticResource LabelText}"/>
                        <TextBox Text="{Binding SelectedWaypoint.Altitude, StringFormat=F1, UpdateSourceTrigger=PropertyChanged}" 
                                Style="{StaticResource ValueInput}" Height="26" FontSize="10"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2">
                        <TextBlock Text="RADIUS (m)" Style="{StaticResource LabelText}"/>
                        <TextBox Text="{Binding SelectedWaypoint.Radius, StringFormat=F1, UpdateSourceTrigger=PropertyChanged}" 
                                Style="{StaticResource ValueInput}" Height="26" FontSize="10"/>
                    </StackPanel>

                    <Button Grid.Column="4" Content="APPLY" Command="{Binding ApplyEditCommand}" 
                           Style="{StaticResource SmallButton}" Background="{StaticResource AccentBlue}" 
                           VerticalAlignment="Bottom" Width="60"/>
                </Grid>
            </Grid>
        </Border>

        <!-- Reorder & Edit Buttons -->
        <Grid Grid.Row="5" Margin="0,0,0,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Content="â–²" Command="{Binding MoveUpCommand}" Style="{StaticResource SmallButton}" ToolTip="Move Up"/>
            <Button Grid.Column="1" Content="â–¼" Command="{Binding MoveDownCommand}" Style="{StaticResource SmallButton}" ToolTip="Move Down"/>
            <Button Grid.Column="2" Content="+â–²" Command="{Binding InsertBeforeCommand}" Style="{StaticResource SmallButton}" ToolTip="Insert Before"/>
            <Button Grid.Column="3" Content="+â–¼" Command="{Binding InsertAfterCommand}" Style="{StaticResource SmallButton}" ToolTip="Insert After"/>
            <Button Grid.Column="4" Content="ðŸ " Command="{Binding SetHomeCommand}" Style="{StaticResource SmallButton}" ToolTip="Set as Home"/>
            <Button Grid.Column="5" Content="âœ•" Command="{Binding RemoveSelectedCommand}" Style="{StaticResource SmallButton}" 
                   Background="{StaticResource AccentRed}" ToolTip="Remove"/>
        </Grid>

        <!-- Main Action Buttons -->
        <Grid Grid.Row="6">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <Button Grid.Column="0" Content="â¬† UPLOAD" Command="{Binding UploadCommand}" 
                   Style="{StaticResource ActionButton}" Background="{StaticResource AccentGreen}"/>
            <Button Grid.Column="1" Content="â¬‡ DOWN" Command="{Binding DownloadCommand}" 
                   Style="{StaticResource ActionButton}" Background="{StaticResource AccentBlue}"/>
            <Button Grid.Column="2" Content="ðŸ“ IMPORT" Command="{Binding ImportCommand}" 
                   Style="{StaticResource ActionButton}" Background="{StaticResource AccentPurple}"/>
            <Button Grid.Column="3" Content="ðŸ’¾ EXPORT" Command="{Binding ExportCommand}" 
                   Style="{StaticResource ActionButton}" Background="{StaticResource AccentOrange}"/>
        </Grid>
    </Grid>
</UserControl>
